-- Q1: Total rental income by month
SELECT
  strftime('%Y-%m', payment_date) AS month,
  SUM(amount_num) AS total_rental_income
FROM payments
WHERE payment_status IN ('Paid','Late')
GROUP BY month
ORDER BY month;

-- Q2: Total rental income by property (include properties with zero income)
SELECT
  p.property_id,
  p.property_name,
  COALESCE(SUM(pay.amount_num), 0) AS total_rental_income
FROM properties p
LEFT JOIN units u
  ON u.property_id = p.property_id
LEFT JOIN leases l
  ON l.unit_id = u.unit_id
LEFT JOIN payments pay
  ON pay.lease_id = l.lease_id
 AND pay.payment_status IN ('Paid','Late')
GROUP BY p.property_id, p.property_name
ORDER BY total_rental_income DESC;

-- Q3: Maintenance cost by property and month
SELECT
  m.property_id,
  p.property_name,
  strftime('%Y-%m', m.maintenance_date) AS month,
  SUM(m.cost_num) AS maintenance_cost
FROM maintenance m
JOIN properties p
  ON p.property_id = m.property_id
GROUP BY m.property_id, p.property_name, month
ORDER BY m.property_id, month;

-- Q4: Net income by property (income - maintenance)
WITH income AS (
  SELECT
    p.property_id,
    SUM(pay.amount_num) AS income
  FROM properties p
  LEFT JOIN units u ON u.property_id = p.property_id
  LEFT JOIN leases l ON l.unit_id = u.unit_id
  LEFT JOIN payments pay
    ON pay.lease_id = l.lease_id
   AND pay.payment_status IN ('Paid','Late')
  GROUP BY p.property_id
),
maint AS (
  SELECT
    property_id,
    SUM(cost_num) AS maintenance_cost
  FROM maintenance
  GROUP BY property_id
)
SELECT
  p.property_id,
  p.property_name,
  COALESCE(i.income,0) AS income,
  COALESCE(m.maintenance_cost,0) AS maintenance_cost,
  COALESCE(i.income,0) - COALESCE(m.maintenance_cost,0) AS net_income
FROM properties p
LEFT JOIN income i ON i.property_id = p.property_id
LEFT JOIN maint m ON m.property_id = p.property_id
ORDER BY net_income DESC;

-- Q5: Occupancy rate per property (Active leases / total units)
SELECT
  p.property_id,
  p.property_name,
  p.units_count,
  COUNT(DISTINCT CASE WHEN l.lease_status = 'Active' THEN u.unit_id END) AS occupied_units,
  ROUND(
    (COUNT(DISTINCT CASE WHEN l.lease_status = 'Active' THEN u.unit_id END) * 1.0) / p.units_count
  , 3) AS occupancy_rate
FROM properties p
LEFT JOIN units u
  ON u.property_id = p.property_id
LEFT JOIN leases l
  ON l.unit_id = u.unit_id
GROUP BY p.property_id, p.property_name, p.units_count
ORDER BY occupancy_rate DESC;

-- Q6: Vacancy rate per property (1 - occupancy)
WITH occ AS (
  SELECT
    p.property_id,
    p.property_name,
    p.units_count,
    COUNT(DISTINCT CASE WHEN l.lease_status = 'Active' THEN u.unit_id END) AS occupied_units
  FROM properties p
  LEFT JOIN units u ON u.property_id = p.property_id
  LEFT JOIN leases l ON l.unit_id = u.unit_id
  GROUP BY p.property_id, p.property_name, p.units_count
)
SELECT
  property_id,
  property_name,
  units_count,
  occupied_units,
  (units_count - occupied_units) AS vacant_units,
  ROUND((units_count - occupied_units) * 1.0 / units_count, 3) AS vacancy_rate
FROM occ
ORDER BY vacancy_rate DESC;

-- Q7: Top 5 properties by net income (window function ranking)
WITH net AS (
  WITH income AS (
    SELECT
      p.property_id,
      SUM(pay.amount_num) AS income
    FROM properties p
    LEFT JOIN units u ON u.property_id = p.property_id
    LEFT JOIN leases l ON l.unit_id = u.unit_id
    LEFT JOIN payments pay
      ON pay.lease_id = l.lease_id
     AND pay.payment_status IN ('Paid','Late')
    GROUP BY p.property_id
  ),
  maint AS (
    SELECT
      property_id,
      SUM(cost_num) AS maintenance_cost
    FROM maintenance
    GROUP BY property_id
  )
  SELECT
    p.property_id,
    p.property_name,
    COALESCE(i.income,0) AS income,
    COALESCE(m.maintenance_cost,0) AS maintenance_cost,
    COALESCE(i.income,0) - COALESCE(m.maintenance_cost,0) AS net_income
  FROM properties p
  LEFT JOIN income i ON i.property_id = p.property_id
  LEFT JOIN maint m ON m.property_id = p.property_id
)
SELECT *
FROM (
  SELECT
    property_id,
    property_name,
    income,
    maintenance_cost,
    net_income,
    DENSE_RANK() OVER (ORDER BY net_income DESC) AS net_income_rank
  FROM net
)
WHERE net_income_rank <= 5
ORDER BY net_income_rank;

-- Q8: Lease expiries in the next 6 months
SELECT
  l.lease_id,
  p.property_name,
  u.unit_id,
  l.tenant_id,
  l.end_date,
  l.monthly_rent
FROM leases l
JOIN units u ON u.unit_id = l.unit_id
JOIN properties p ON p.property_id = u.property_id
WHERE date(l.end_date) >= date('now')
  AND date(l.end_date) < date('now','+6 months')
ORDER BY date(l.end_date) ASC;

-- Q9: Payment status breakdown by month
SELECT
  strftime('%Y-%m', payment_date) AS month,
  payment_status,
  COUNT(*) AS payments_count
FROM payments
GROUP BY month, payment_status
ORDER BY month, payment_status;

-- Q10: Properties with vacancy > 10%
WITH occ AS (
  SELECT
    p.property_id,
    p.property_name,
    p.units_count,
    COUNT(DISTINCT CASE WHEN l.lease_status = 'Active' THEN u.unit_id END) AS occupied_units
  FROM properties p
  LEFT JOIN units u ON u.property_id = p.property_id
  LEFT JOIN leases l ON l.unit_id = u.unit_id
  GROUP BY p.property_id, p.property_name, p.units_count
)
SELECT
  property_id,
  property_name,
  units_count,
  (units_count - occupied_units) AS vacant_units,
  ROUND((units_count - occupied_units) * 1.0 / units_count, 3) AS vacancy_rate
FROM occ
WHERE ((units_count - occupied_units) * 1.0 / units_count) > 0.10
ORDER BY vacancy_rate DESC;

